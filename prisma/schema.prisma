generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

enum ROLE {
  USER
  ADMIN
}

model User {
  id           String     @id @default(uuid())
  username     String
  email        String     @unique
  password     String?
  profileImage String?    @default("")
  role         ROLE       @default(USER)
  isBlocked    Boolean    @default(false)
  blockedAt    DateTime?
  blockedBy    String?
  otp          String?
  otpExpiresAt DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  Credit       Credit?
  images       Image[]
  videos       Video[]
  auditLogs    AuditLog[]
}

model Credit {
  id        String   @id @default(uuid())
  userId    String   @unique
  credits   Int      @default(2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Image {
  id              String             @id @default(uuid())
  publicId        String
  userId          String
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime           @default(now())
  deletedAt       DateTime?
  deletedBy       String?
  transformations TransformedImage[]
}

enum TransformationType {
  DERIVED // resize, crop, format, quality
  IRREVERSIBLE // bg remove, AI edits
}

model TransformedImage {
  id                 String             @id @default(uuid())
  imageId            String
  image              Image              @relation(fields: [imageId], references: [id], onDelete: Cascade)
  publicId           String // original or transformed
  transformation     Json? // NULL for irreversible ops
  transformationHash String
  type               TransformationType @default(DERIVED)
  createdAt          DateTime           @default(now())

  @@unique([imageId, transformationHash])
  @@index([imageId])
}

model Video {
  id           String    @id @default(uuid())
  title        String
  description  String?
  publicId     String
  originalSize String
  compressSize String
  duration     Float
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  deletedAt    DateTime?
  deletedBy    String?
}

enum AuditAction {
  USER_BLOCK
  USER_UNBLOCK
  ROLE_CHANGE
  USER_DELETE
  MEDIA_DELETE
  MEDIA_RESTORE
  CREDIT_ADJUST
}

model AuditLog {
  id        String      @id @default(uuid())
  adminId   String
  admin     User        @relation(fields: [adminId], references: [id])
  action    AuditAction
  targetId  String?
  meta      Json?
  createdAt DateTime    @default(now())

  @@index([action])
  @@index([createdAt])
}
